package org.utbot.intellij.plugin.javadoc

import com.intellij.codeInsight.javadoc.JavaDocExternalFilter
import com.intellij.codeInsight.javadoc.JavaDocInfoGeneratorFactory
import com.intellij.lang.java.JavaDocumentationProvider
import com.intellij.psi.PsiDocCommentBase
import com.intellij.psi.PsiJavaDocumentedElement

/**
 * To render UtBot custom JavaDoc tags messages, we need to override basic behaviour of [JavaDocumentationProvider].
 * The IJ platform knows only custom tag names, so we need to add their messages in rendered comments to make it look nice.
 */
class UtDocumentationProvider : JavaDocumentationProvider() {
    override fun generateRenderedDoc(comment: PsiDocCommentBase): String? {
        val target = comment.owner ?: comment

        if (target !is PsiJavaDocumentedElement) {
            return ""
        }

        val baseJavaDocInfoGenerator = JavaDocInfoGeneratorFactory.getBuilder(target.getProject())
            .setPsiElement(target)
            .setIsGenerationForRenderedDoc(true)
            .create()

        val finalDocContent = replaceTagNamesWithMessages(baseJavaDocInfoGenerator.generateRenderedDocInfo())

        return JavaDocExternalFilter.filterInternalDocInfo(finalDocContent)
    }

    /**
     * Replaces names of plugin's custom JavaDoc tags with their messages in the comment generated by the IJ platform.
     * Example: utbot.MethodUnderTest -> Method under test.
     */
    private fun replaceTagNamesWithMessages(comment: String?) =
        comment?.let {
            val docTagProvider = UtCustomJavaDocTagProvider()
            docTagProvider.supportedTags.fold(it) { result, tag ->
                if (result.contains(tag.name)) {
                    result.replace(tag.name, "${tag.getMessage()}:")
                } else {
                    result
                }
            }
        } ?: ""
}